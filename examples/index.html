<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>音频捕获插件演示</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #333;
    }
    .section {
      margin-bottom: 30px;
      padding: 15px;
      border-radius: 6px;
      background-color: #f9f9f9;
    }
    .section h2 {
      margin-top: 0;
      color: #0078d7;
    }
    input {
      padding: 8px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    button {
      padding: 8px 16px;
      background-color: #0078d7;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    button:hover {
      background-color: #005a9e;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .result {
      margin-top: 15px;
      padding: 10px;
      border-left: 4px solid #0078d7;
      background-color: #f0f0f0;
      min-height: 20px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    tr.selected {
      background-color: #e0f0ff;
    }
    #audioLog {
      height: 200px;
      overflow-y: auto;
    }
    .app-icon {
      width: 32px;
      height: 32px;
      vertical-align: middle;
      margin-right: 8px;
    }
    .app-info {
      display: flex;
      align-items: center;
    }
    .status-authorized {
      color: green;
      font-weight: bold;
    }
    .status-denied {
      color: red;
      font-weight: bold;
    }
    .status-unknown {
      color: orange;
      font-weight: bold;
    }
    .audio-controls {
      margin-top: 15px;
      padding: 15px;
      background-color: #e8f4ff;
      border-radius: 6px;
    }
    .audio-player {
      width: 100%;
      margin-top: 10px;
    }
    .record-button {
      background-color: #d32f2f;
    }
    .record-button:hover {
      background-color: #b71c1c;
    }
    .play-button {
      background-color: #388e3c;
    }
    .play-button:hover {
      background-color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>音频捕获插件演示</h1>
    <p>这个示例展示了如何使用electron-audio-capture插件捕获指定进程的音频</p>
    
    <div class="section">
      <h2>1. 权限管理</h2>
      <div>
        <button id="checkPermissionButton">检查权限</button>
        <button id="requestPermissionButton">请求权限</button>
      </div>
      <div class="result" id="permissionStatus">权限状态将显示在这里...</div>
    </div>
    
    <div class="section">
      <h2>2. 测试Hello World</h2>
      <div>
        <input type="text" id="message" placeholder="输入消息..." value="你好，世界！">
        <button id="helloButton">发送到原生模块</button>
      </div>
      <div class="result" id="helloResult">结果将显示在这里...</div>
    </div>
    
    <div class="section">
      <h2>3. 获取进程列表</h2>
      <button id="getProcessesButton">获取进程列表</button>
      <div class="result">
        <table id="processTable">
          <thead>
            <tr>
              <th>图标</th>
              <th>PID</th>
              <th>进程名</th>
              <th>描述</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="processTableBody">
            <tr>
              <td colspan="5">点击上方按钮获取进程列表</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="section">
      <h2>4. 捕获音频</h2>
      <div>
        <button id="startCaptureButton" disabled>开始捕获</button>
        <button id="stopCaptureButton" disabled>停止捕获</button>
      </div>
      <div class="result" id="captureStatus">未开始捕获</div>
      
      <div class="audio-controls">
        <h3>音频录制与播放</h3>
        <div>
          <button id="startRecordButton" class="record-button" disabled>开始录制</button>
          <button id="stopRecordButton" class="record-button" disabled>停止录制</button>
          <button id="playAudioButton" class="play-button" disabled>播放录制的音频</button>
        </div>
        <div id="recordingStatus" style="margin-top: 10px;">未开始录制</div>
        <audio id="audioPlayer" class="audio-player" controls></audio>
      </div>
      
      <h3>音频数据日志</h3>
      <div class="result" id="audioLog"></div>
    </div>
  </div>

  <script>
    // 全局变量
    let selectedPid = null;
    let isCapturing = false;
    let audioDataCount = 0;
    let isRecording = false;
    let audioChunks = [];
    let audioContext = null;
    let audioBuffers = [];
    let recordingStartTime = 0;

    // 将Uint8Array转换为Base64字符串
    function arrayBufferToBase64(buffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const len = bytes.byteLength;
      for (let i = 0; i < len; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }
    
    // 将Base64字符串转换回ArrayBuffer
    function base64ToArrayBuffer(base64) {
      const binaryString = window.atob(base64);
      const len = binaryString.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // 更新权限状态显示
    function updatePermissionStatus(status) {
      const permissionStatusElement = document.getElementById("permissionStatus");
      permissionStatusElement.innerHTML = `
        权限状态: <span class="status-${status.status}">${status.status}</span>
      `;
      
      // 根据权限状态更新UI
      const getProcessesButton = document.getElementById("getProcessesButton");
      getProcessesButton.disabled = status.status !== "authorized";
      
      if (status.status !== "authorized") {
        const processTableBody = document.getElementById("processTableBody");
        processTableBody.innerHTML = '<tr><td colspan="5">需要音频捕获权限才能获取进程列表</td></tr>';
      }
    }
    
    // 创建WAV文件
    function createWAV(audioBuffers, channels, sampleRate) {
      // 计算总数据长度
      let totalLength = 0;
      audioBuffers.forEach(buffer => {
        totalLength += buffer.byteLength;
      });
      
      // WAV文件头大小
      const headerSize = 44;
      
      // 创建WAV文件缓冲区
      const wav = new ArrayBuffer(headerSize + totalLength);
      const view = new DataView(wav);
      
      // 写入WAV文件头
      // "RIFF" 标识
      view.setUint8(0, 'R'.charCodeAt(0));
      view.setUint8(1, 'I'.charCodeAt(0));
      view.setUint8(2, 'F'.charCodeAt(0));
      view.setUint8(3, 'F'.charCodeAt(0));
      
      // 文件大小
      view.setUint32(4, 36 + totalLength, true);
      
      // "WAVE" 标识
      view.setUint8(8, 'W'.charCodeAt(0));
      view.setUint8(9, 'A'.charCodeAt(0));
      view.setUint8(10, 'V'.charCodeAt(0));
      view.setUint8(11, 'E'.charCodeAt(0));
      
      // "fmt " 子块
      view.setUint8(12, 'f'.charCodeAt(0));
      view.setUint8(13, 'm'.charCodeAt(0));
      view.setUint8(14, 't'.charCodeAt(0));
      view.setUint8(15, ' '.charCodeAt(0));
      
      // 子块大小
      view.setUint32(16, 16, true);
      
      // 音频格式 (1 表示 PCM)
      view.setUint16(20, 1, true);
      
      // 声道数
      view.setUint16(22, channels, true);
      
      // 采样率
      view.setUint32(24, sampleRate, true);
      
      // 字节率 (采样率 * 每个样本的字节数)
      const bytesPerSample = 2; // 16位音频
      view.setUint32(28, sampleRate * channels * bytesPerSample, true);
      
      // 块对齐 (声道数 * 每个样本的字节数)
      view.setUint16(32, channels * bytesPerSample, true);
      
      // 每个样本的位数
      view.setUint16(34, 8 * bytesPerSample, true);
      
      // "data" 子块
      view.setUint8(36, 'd'.charCodeAt(0));
      view.setUint8(37, 'a'.charCodeAt(0));
      view.setUint8(38, 't'.charCodeAt(0));
      view.setUint8(39, 'a'.charCodeAt(0));
      
      // 数据大小
      view.setUint32(40, totalLength, true);
      
      // 写入音频数据
      let offset = 44;
      audioBuffers.forEach(buffer => {
        const data = new Uint8Array(buffer);
        for (let i = 0; i < data.length; i++) {
          view.setUint8(offset + i, data[i]);
        }
        offset += buffer.byteLength;
      });
      
      return wav;
    }

    // 文档加载完成后执行
    document.addEventListener("DOMContentLoaded", () => {
      console.log("渲染进程已加载");
      
      // 检查权限
      const checkPermissionButton = document.getElementById("checkPermissionButton");
      checkPermissionButton.addEventListener("click", async () => {
        try {
          const permission = await window.electronAPI.checkPermission();
          updatePermissionStatus(permission);
        } catch (error) {
          document.getElementById("permissionStatus").textContent = `检查权限出错: ${error}`;
        }
      });
      
      // 请求权限
      const requestPermissionButton = document.getElementById("requestPermissionButton");
      requestPermissionButton.addEventListener("click", async () => {
        try {
          document.getElementById("permissionStatus").textContent = "正在请求权限...";
          const permission = await window.electronAPI.requestPermission();
          updatePermissionStatus(permission);
        } catch (error) {
          document.getElementById("permissionStatus").textContent = `请求权限出错: ${error}`;
        }
      });
      
      // 初始检查权限
      window.electronAPI.checkPermission().then(updatePermissionStatus);
      
      // 测试Hello World
      const helloButton = document.getElementById("helloButton");
      const messageInput = document.getElementById("message");
      const helloResult = document.getElementById("helloResult");

      helloButton.addEventListener("click", async () => {
        const message = messageInput.value;
        try {
          const result = await window.electronAPI.helloWorld(message);
          helloResult.textContent = result;
        } catch (error) {
          helloResult.textContent = `错误: ${error}`;
        }
      });

      // 获取进程列表
      const getProcessesButton = document.getElementById("getProcessesButton");
      const processTableBody = document.getElementById("processTableBody");
      const captureStatus = document.getElementById("captureStatus");

      getProcessesButton.addEventListener("click", async () => {
        try {
          // 先检查权限
          const permission = await window.electronAPI.checkPermission();
          if (permission.status !== "authorized") {
            processTableBody.innerHTML = '<tr><td colspan="5">需要音频捕获权限才能获取进程列表</td></tr>';
            return;
          }
          
          const processes = await window.electronAPI.getProcessList();

          if (processes.length === 0) {
            processTableBody.innerHTML =
              '<tr><td colspan="5">没有找到可捕获音频的进程</td></tr>';
            return;
          }

          processTableBody.innerHTML = "";
          processes.forEach((process) => {
            const row = document.createElement("tr");

            // 创建图标单元格
            const iconCell = document.createElement("td");
            if (process.icon && process.icon.data) {
              // 将图标数据转换为Base64并创建图像元素
              const base64Icon = arrayBufferToBase64(process.icon.data.buffer);
              const imgSrc = `data:image/${process.icon.format};base64,${base64Icon}`;

              const iconImg = document.createElement("img");
              iconImg.src = imgSrc;
              iconImg.className = "app-icon";
              iconImg.alt = process.name;

              iconCell.appendChild(iconImg);
            } else {
              iconCell.textContent = "无图标";
            }

            // 创建其他单元格
            const pidCell = document.createElement("td");
            pidCell.textContent = process.pid.toString();

            const nameCell = document.createElement("td");
            nameCell.textContent = process.name;

            const descCell = document.createElement("td");
            descCell.textContent = process.description;

            const actionCell = document.createElement("td");
            const selectButton = document.createElement("button");
            selectButton.textContent = "选择";
            selectButton.className = "selectProcessButton";
            actionCell.appendChild(selectButton);

            // 添加所有单元格到行
            row.appendChild(iconCell);
            row.appendChild(pidCell);
            row.appendChild(nameCell);
            row.appendChild(descCell);
            row.appendChild(actionCell);

            // 添加选择按钮事件监听器
            selectButton.addEventListener("click", () => {
              // 移除之前选中的行的高亮
              document
                .querySelectorAll("#processTable tr.selected")
                .forEach((tr) => {
                  tr.classList.remove("selected");
                });

              // 高亮当前选中的行
              row.classList.add("selected");

              // 保存选中的进程ID
              selectedPid = process.pid;

              // 更新UI状态
              const startCaptureButton = document.getElementById("startCaptureButton");
              startCaptureButton.disabled = false;
              captureStatus.textContent = `已选择进程: ${process.name} (PID: ${process.pid})`;
            });

            processTableBody.appendChild(row);
          });
        } catch (error) {
          processTableBody.innerHTML = `<tr><td colspan="5">获取进程列表时出错: ${error}</td></tr>`;
        }
      });

      // 开始捕获
      const startCaptureButton = document.getElementById("startCaptureButton");
      const stopCaptureButton = document.getElementById("stopCaptureButton");
      const audioLog = document.getElementById("audioLog");
      const startRecordButton = document.getElementById("startRecordButton");
      const stopRecordButton = document.getElementById("stopRecordButton");
      const playAudioButton = document.getElementById("playAudioButton");
      const recordingStatus = document.getElementById("recordingStatus");
      const audioPlayer = document.getElementById("audioPlayer");

      startCaptureButton.addEventListener("click", async () => {
        if (!selectedPid) {
          alert("请先选择一个进程");
          return;
        }

        try {
          // 先检查权限
          const permission = await window.electronAPI.checkPermission();
          if (permission.status !== "authorized") {
            captureStatus.textContent = "需要音频捕获权限才能开始捕获";
            return;
          }
          
          const result = await window.electronAPI.startCapture(selectedPid);

          if (result) {
            isCapturing = true;
            startCaptureButton.disabled = true;
            stopCaptureButton.disabled = false;
            startRecordButton.disabled = false;
            captureStatus.textContent = `正在捕获PID为${selectedPid}的进程音频...`;

            // 清空音频日志
            audioLog.textContent = "";
            audioDataCount = 0;

            // 设置音频数据监听器
            window.electronAPI.onAudioData((data) => {
              audioDataCount++;

              // 添加新的日志条目
              const entry = document.createElement("div");
              entry.textContent = `[${new Date(
                data.timestamp
              ).toLocaleTimeString()}] 接收到音频数据: ${data.dataSize} 字节, ${
                data.channels
              } 通道, ${data.sampleRate} Hz`;

              // 如果日志条目太多，移除最早的
              if (audioDataCount > 100) {
                const firstChild = audioLog.firstChild;
                if (firstChild) {
                  audioLog.removeChild(firstChild);
                }
              }

              // 添加到日志末尾
              audioLog.appendChild(entry);

              // 滚动到底部
              audioLog.scrollTop = audioLog.scrollHeight;
              
              // 如果正在录制，保存音频数据
              if (isRecording && data.audioBuffer) {
                // 将Base64字符串转换回ArrayBuffer
                const audioBuffer = base64ToArrayBuffer(data.audioBuffer);
                audioBuffers.push(audioBuffer);
              }
            });
          } else {
            captureStatus.textContent = "开始捕获失败";
          }
        } catch (error) {
          captureStatus.textContent = `开始捕获时出错: ${error}`;
        }
      });

      // 停止捕获
      stopCaptureButton.addEventListener("click", async () => {
        try {
          const result = await window.electronAPI.stopCapture();

          if (result) {
            isCapturing = false;
            startCaptureButton.disabled = false;
            stopCaptureButton.disabled = true;
            startRecordButton.disabled = true;
            stopRecordButton.disabled = true;
            captureStatus.textContent = "已停止捕获";

            // 如果正在录制，也停止录制
            if (isRecording) {
              stopRecording();
            }

            // 移除音频数据监听器
            window.electronAPI.removeAudioDataListener();
          } else {
            captureStatus.textContent = "停止捕获失败";
          }
        } catch (error) {
          captureStatus.textContent = `停止捕获时出错: ${error}`;
        }
      });
      
      // 开始录制
      startRecordButton.addEventListener("click", () => {
        if (!isCapturing) {
          alert("请先开始捕获音频");
          return;
        }
        
        // 清空之前的录制
        audioBuffers = [];
        recordingStartTime = Date.now();
        isRecording = true;
        
        // 更新UI
        startRecordButton.disabled = true;
        stopRecordButton.disabled = false;
        playAudioButton.disabled = true;
        recordingStatus.textContent = "正在录制...";
      });
      
      // 停止录制
      stopRecordButton.addEventListener("click", () => {
        if (!isRecording) {
          return;
        }
        
        stopRecording();
      });
      
      // 停止录制函数
      function stopRecording() {
        isRecording = false;
        
        // 更新UI
        startRecordButton.disabled = false;
        stopRecordButton.disabled = true;
        
        const recordingDuration = (Date.now() - recordingStartTime) / 1000;
        recordingStatus.textContent = `录制完成，时长: ${recordingDuration.toFixed(2)} 秒`;
        
        // 如果有录制的音频数据
        if (audioBuffers.length > 0) {
          // 假设所有音频数据具有相同的格式
          const channels = 2; // 假设立体声
          const sampleRate = 44100; // 假设44.1kHz
          
          // 创建WAV文件
          const wavBuffer = createWAV(audioBuffers, channels, sampleRate);
          
          // 创建Blob对象
          const blob = new Blob([wavBuffer], { type: 'audio/wav' });
          
          // 创建URL并设置给audio元素
          const url = URL.createObjectURL(blob);
          audioPlayer.src = url;
          
          // 启用播放按钮
          playAudioButton.disabled = false;
        } else {
          recordingStatus.textContent = "录制失败：没有捕获到音频数据";
          playAudioButton.disabled = true;
        }
      }
      
      // 播放录制的音频
      playAudioButton.addEventListener("click", () => {
        if (audioPlayer.src) {
          audioPlayer.play();
        }
      });
    });
  </script>
</body>
</html>